<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>x-spreadsheet-demo</title>
    <link rel="stylesheet" href="./xspreadsheet.css?v=20220712">
    <link rel="stylesheet" href="./quantumui.min.22.5.5.2.css?v=20220312">
    <link rel="stylesheet" href="./bootstrap.min.22.5.5.2.css?v=20220315">
 
    <script src="./xspreadsheet.js?v=20220712"></script>
    <script type="text/javascript" src="jquery-2.1.1.js"></script>
    <script type="text/javascript" src="jszip.min.js"></script>
  
	
 
</head>
 
<body>
 <!--<input type="file" name="imagef" id="imagef" >
<span id="status"></span> <button onclick="save()">save</button>
<button onclick="addimage()">add image</button>
<button onclick="addimagebyUrl()">add image from url</button>
-->
<div id="gridjs-demo"></div>
<!-- <button onclick="loadmore()">next</button> -->
<!-- <button onclick="print()">print</button> -->

 
 
<script>
        function downLoad(url) {
            var oA = document.createElement("a");
            oA.download = '';// 设置下载的文件名，默认是'下载'
            oA.href = url;
            document.body.appendChild(oA);
            oA.click();
            oA.remove(); // 下载之后把创建的元素删除
        }
        function saveAsPNG(canvas) {
            return canvas.toDataURL("image/png");
            //return canvas.toDataURL("image/jpeg", 1.0);
        }

        function savepng() {
            downLoad(saveAsPNG(document.querySelector("#gridjs-demo > div > div.x-spreadsheet-sheet > canvas")));
        }
        function savepngwithsize(w, h) {
            var x = document.createElement("CANVAS");
            x.width = w;
            x.height = h;
            var imgdata = document.querySelector("#gridjs-demo > div > div.x-spreadsheet-sheet > canvas").getContext("2d").getImageData(0, 0, w, h);
            var ctx = x.getContext("2d");
            ctx.putImageData(imgdata, 0, 0);
            downLoad(saveAsPNG(x));
        }
        function savepngwithsizeid(id, w, h) {
            var x = document.createElement("CANVAS");
            x.width = w;
            x.height = h;
            var imgdata = document.getElementById(id).getContext("2d").getImageData(0, 0, w, h);
            var ctx = x.getContext("2d");
            ctx.putImageData(imgdata, 0, 0);
            downLoad(saveAsPNG(x));
        }
        // var vConsole = new window.VConsole();
        function getQueryVariable(variable) {
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return(false);
}
        let xs;
        let rdata;
        let uniqueid;
    //var local = 'http://localhost:24262';
        let imagediv = "imagedive";
        let basiczorder = 5678;
    let sheets = [];
        let jsondata = null;
    $(function () {

        $.ajax({

            url:  '/GridJs2/DetailFileJson?filename='+getQueryVariable("file"),

            type: 'GET',

            dataType: 'text',

            timeout: 59000,

            cache: false,

            beforeSend: LoadFunction,  

            error: erryFunction,  

            success: succFunction 

        })

        function LoadFunction() {

            $("#status").html('loading...');

        }

        function erryFunction() {

            alert("error");

        }

        function succFunction(tt) {
            $("#status").html('success');

            var exceldata = tt;
            //.replace(/\n/g,"\\\\n");
                jsondata = JSON.parse(exceldata);
                if (jsondata.Error) {
                    alert(jsondata.Error);
			}
			else{
                    loadWithCustomContextMenu(jsondata);
			}
        }
    });

        let isHighlightAll = false;
        let isShowHighlight = false;
        const highlightStyle = { 'color': 'rgba(251, 12, 251, 0.2)' };

        const onMyActionClick1 = (sheet) => {
            console.log('my action clicked1' + sheet.data.name)
        };
        const loadNormalContext = (sheet) => {
            const option = {
                updateMode: 'server',
                updateUrl: '/GridJs2/UpdateCell',
                showToolbar: true,
                //showGrid: true,
                mode: 'edit',
                //support multiple language ,the locale is: en zh es pt de ru nl
                local: 'en'

            };
            loadWithOption(jsondata, option);
        };
   
        const highlightSelect = (sheet) => {
            isShowHighlight = true;
            sheet.showHighlights(highlightStyle);
            sheet.removeHighlightInverseRange();
            const r = sheet.selector.range;
            sheet.addHighlightRange(r.sri, r.sci, r.eri, r.eci);
            sheet.table.render();
            //for shape or image ，when trigger context menu,it will always select on cell area ,not on obj, 
            //so if you want to highlight shape or image, ececute the below js after mouse left click on shape or image
            /*
             //getObj will return null when trigger context menu
             const img = sheet.selector.getObj();
             if (img) {
                 if (img.type === 'Picture') {
                     sheet.addHighlightImage(img.id);
                 } else {
                     sheet.addHighlightShape(img.id);
                 }
             }
             */
        };
        const highlightInverseRange = (sheet) => {
            sheet.delCustomContextMenuItems(['key4']);
            const range = sheet.getHighlightInverseRange();
            if (range) {
                sheet.removeHighlightInverseRange();

                sheet.insertCustomContextMenuItem({ 'key': 'key4', 'text': 'highlight inverse range for select ', 'callback': highlightInverseRange }, 4);
            } else {
                isShowHighlight = true;
           
                sheet.showHighlights(highlightStyle);
                const r = sheet.selector.range;
                sheet.setHighlightInverseRange(r.sri, r.sci, r.eri, r.eci);
                sheet.insertCustomContextMenuItem({ 'key': 'key4', 'text': 'remove highlight inverse range  ', 'callback': highlightInverseRange }, 4);
            }
            sheet.table.render();
        };

        const highlightAll = (sheet) => {
            isShowHighlight = true;
            isHighlightAll = !isHighlightAll;
            sheet.showHighlights(highlightStyle);
            sheet.setHighlightAll(isHighlightAll);
            //update customcontext menu item
            sheet.updateCustomContextMenuItem('key5', { 'text': 'highlight all to be->' + !isHighlightAll });
            //sheet.addCustomContextMenuItems([{ 'key': 'key5', 'text': 'highlight all to be->' + !isHighlightAll, 'callback': highlightAll }]);
        };
        const showOrHideHighlight = (sheet) => {
            sheet.delCustomContextMenuItems(['key6']);
            if (isShowHighlight) {
                sheet.hideHighlights();
                isShowHighlight = false;
                sheet.insertCustomContextMenuItem({ 'key': 'key6', 'text': 'show highlight  ', 'callback': showOrHideHighlight }, 6);
            } else {
                sheet.showHighlights(highlightStyle);
                isShowHighlight = true;
                sheet.insertCustomContextMenuItem({ 'key': 'key6', 'text': 'hide highlight  ', 'callback': showOrHideHighlight }, 6);
            }
            sheet.table.render();
   
        };
        function loadWithCustomContextMenu(jsondata) {
            const option = {
                updateMode: 'server',
                updateUrl: '/GridJs2/UpdateCell',
                showToolbar: true,
                //showGrid: true,
                mode: 'edit',
                //support multiple language ,the locale is: en zh es pt de ru nl
                local: 'en',
                showContextmenu: true,
                contextMenuItems: {
                    usedefault: false,
                    customItems: [{ 'key': 'key1', 'text': '↓↓↓this is a custom context menu↓↓↓', 'callback': onMyActionClick1 },
                    { 'key': 'key2', 'text': 'click to load normal context menu', 'callback': loadNormalContext },
                    { 'key': 'divider' },
                    { 'key': 'key3', 'text': 'add select area to highlight  ', 'callback': highlightSelect },
                    { 'key': 'key4', 'text': 'highlight inverse range for select ', 'callback': highlightInverseRange },
                    { 'key': 'key5', 'text': 'highlight all to be->' + !isHighlightAll, 'callback': highlightAll },
                    { 'key': 'key6', 'text': 'hide highlight  ', 'callback': showOrHideHighlight }]
                }
            };
            loadWithOption(jsondata, option);

        }
        function loadWithOption(jsondata, option) {
            $('#gridjs-demo').empty();
        //record uniqueid
        uniqueid = jsondata.uniqueid;
        sheets = jsondata.data;
        const filename=jsondata.filename;
        const fileDownloadUrl =  "/GridJs2/Download"
        const imageurl =  "/GridJs2/imageurl";
		const imageuploadurl1 =  "/GridJs2/AddImage";
		const imageuploadurl2 =   "/GridJs2/AddImageByURL";
		const imagecopyurl =  "/GridJs2/CopyImage";        // x.spreadsheet.locale('zh-cn');
            xs = x_spreadsheet('#gridjs-demo', option).loadData(sheets).change((cdata) => {
                console.log(cdata);
                console.log(xs.validate());
            }
        ).updateServerError((xhr, textStatus, errorThrown) => {
                const s = ("error---") + ("code：" + xhr.status) + ("state:" + xhr.readyState) + ("msg:" + xhr.statusText) + ("text：" + xhr.responseText) + ("request status：" + textStatus) + (errorThrown);
                console.log(s);
               
            }).updateCellError((msg) => {

                console.error(msg);
                // xs.sheet.data.restoreLastCell();
				alert(msg);
               
            });

            if (!jsondata.showtabs) {
			xs.bottombar.hide();
		}

		 xs.on('cell-selected', (cell, ri, ci) => {
          console.log('cell:', cell, ', ri:', ri, ', ci:', ci);
        }).on('cell-edited', (text, ri, ci) => {
          console.log('text:', text, ', ri: ', ri, ', ci:', ci);
        });

        $(".x-spreadsheet-overlayer-content").append('<div id="' + imagediv + '" style="position:relative" /> ');
		let myimagediv= $("#" + imagediv);
		   
		    xs.setUniqueId(uniqueid);
			xs.setFileName(filename);
            xs.setImageInfo(myimagediv,imageurl,imageuploadurl1,imageuploadurl2,imagecopyurl,basiczorder);
            xs.setFileDownloadInfo(fileDownloadUrl)
        //need to extend swapfunction
        var oldswapfunc = xs.bottombar.swapFunc;
        xs.bottombar.swapFunc = function (id) {
			 
			//xs.sheet.data.settings.showGrid=sheets[id].showGrid;
            oldswapfunc(id);
                if (xs.sheet.data.autoFilter.filters.length > 0) {
				xs.sheet.data.resetAutoFilter();
                xs.sheet.data.deleteExceptRowHideForAutoFilter();
			 }
          
        }
        xs.setActiveSheetByName(jsondata.actname).setActiveCell(jsondata.actrow,jsondata.actcol);
 
    }
 
 
    function save() {
            if (!xs.buffer.isFinish()) {
			alert("updating is inprogress,please try later");
			return;
		}
		let datas=xs.datas;
		delete datas.history;
        delete datas.search;
		delete datas.images;
		delete datas.shapes;
 
        var jsondata = {
			"sheetname":xs.sheet.data.name,
			"actrow":xs.sheet.data.selector.ri,
            "actcol":xs.sheet.data.selector.ci,
            "datas": xs.getUpdateDatas()
        };
	 
 const data = {
            "p": JSON.stringify(jsondata),
            "uid": uniqueid
        };

  
  $.ajax({
            url: local + '/GridJs2/Download',
            type: "post",
           
            data: data,
            success: function (datar, stutas, xhr) {
				  console.log(datar);
				 if(datar.startsWith("{")){
					var ret = JSON.parse(datar);
                        if (ret.err) {
						alert(ret.err);
					}
				}
                else{
               // window.location = local + '/GridJs2/Download2/' + datar;
			    window.location =datar;
				}
            }
        });
		 
      
    }
 
</script>

</body>
</html>
